<!doctype html>
<html lang="pt-br">
  <head>
    <title>PouPix</title>
    <!-- meta tags obrigatórias -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <!-- bootstrap css -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <!-- bootstrap icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <link rel="stylesheet" href="../css/dropdown.css">
    <script src="../js/functions-nav.js"></script>

    <!-- estilos personalizados -->
    <style>
      main.margin {
        margin-top: 90px !important;
      }

      .width {
        width: 120px;
      }

      .line {
        display: none;
      }

      /* ajustes para telas pequenas */
      @media only screen and (max-width: 992px) {
        .date {
          display: none;
        }

        /* remove borda esquerda em telas pequenas */
        .border-start {
          border: 0 !important;
        }

        .alinhamento {
          text-align: center;
        }

        .titulo {
          margin-bottom: 30px !important;
        }

        main.margin {
          margin-top: 60px !important;
        }

        .width {
          width: 120px;
        }

        .line {
          display: block;
          margin-top: 20px;
        }

        .alinhar-botoes {
          margin-left: 20px;
        }

        .position {
          padding-right: 0;
        }

        .line-v {
          display: none;
        }

        .col-12.col-md-5 > div {
          width: 100%;
          margin-left: auto;
          margin-right: auto;
        }
      }
    </style>
  </head>

  <body style="background: linear-gradient(176deg, rgba(80,137,145,1) 0%, rgba(201,237,214,1) 100%); background-repeat: no-repeat; background-size: cover;">
    <!-- cabeçalho com barra de navegação -->
    <div id="navbar-placeholder"></div>

    <div class="container" style="margin-top: 50px; padding: 60px;">

      <!-- Header com saudação e data -->
      <div class="col-12 mb-4 col-lg-6">
        <div class="d-flex justify-content-between align-items-center p-3 bg-white rounded-3 shadow-sm" style="height: 60px; margin-left: -9px;">
          <div class="d-flex align-items-center">
            <img src="../imgs/boneco.svg" alt="Usuário" width="40" class="me-3" />
            <div>
              <span class="fw-semibold" style="font-size: 15px;" id="usernameDisplay">Bom dia, Rodrigo</span>
            </div>
          </div>
          <div class="date">
            <span id="currentDate" class="px-3 py-1 rounded-2 text-white" style="background-color: #508991;">May, 13, 2025</span>
          </div>
        </div>
      </div>

      <!-- Área principal -->
      <div class="row align-items-center position" style="min-height: 400px; background: white; border-radius: 12px; padding: 20px;">

        <!-- Lado esquerdo: blocos de receita -->
        <div class="col-12 col-md-5">
          <div onclick="abrirListaReceita()" style="cursor: pointer; background-color: #09BC8A; border-radius: 12px; margin: 20px 0;" class="d-flex align-items-center justify-content-center flex-column">
            <h4 class="text-dark py-2">Receita Mensal</h4>
            <p id="valorTotalReceita" class="fs-5">R$ 0,00</p>
          </div>

          <div onclick="abrirListaDespesa()" style="cursor: pointer; background-color: #DA5F5F; border-radius: 12px; margin: 20px 0;" class="d-flex align-items-center justify-content-center flex-column">
            <h4 class="text-dark py-2">Gasto Mensal</h4>
            <p id="valorTotalDespesa" class="fs-5">R$ 0,00</p>
          </div>

          <div style="background-color: #74B3CE; border-radius: 12px; margin: 20px 0;" class="d-flex align-items-center justify-content-center flex-column">
            <h4 class="text-dark py-2">Saldo Geral</h4>
            <p id="saldoGeral" class="fs-5">R$ 0,00</p>
          </div>
        </div>

        <!-- linha vertical -->
        <div class="col-md-1 d-flex justify-content-center" style="margin-right: 20px;">
        </div>

        <!-- Lado direito: botões -->
        <div class="col-md-5 d-flex flex-column align-items-center justify-content-center flex-lg-row">
          <div>
            <button class="btn d-flex align-items-center justify-content-center ms-1" data-bs-toggle="modal" data-bs-target="#modalReceita">
              <img src="../imgs/receita.svg" alt="Receita" class="width alinhar-botoes" />
            </button>
          </div>
          <div>
            <button class="btn d-flex align-items-center justify-content-center" data-bs-toggle="modal" data-bs-target="#modalDespesa">
              <img src="../imgs/despesa.svg" alt="Despesa" class="width alinhar-botoes" />
            </button>
          </div>
          <div>
            <button class="btn d-flex align-items-center justify-content-center" data-bs-toggle="modal" data-bs-target="#modalImportar">
              <img src="../imgs/importar.svg" alt="Importar" class="width alinhar-botoes" />
            </button>
          </div>
        </div>
      </div>

      <!-- Seção Contas e Cartões -->
      <section class="my-5">
        <div class="row g-4">
          
          <!-- Bloco Contas -->
          <div class="col-lg-6 d-flex card-align-1">
            <div class="border rounded p-4 d-flex flex-column w-100 bg-white">
              <h4 class="fw-bold mb-3 text-dark">Contas</h4>
              <ul class="list-group mb-3">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Conta Corrente
                  <span class="badge rounded-pill" style="background-color: #508991;">R$ 0,00</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Conta Poupança
                  <span class="badge rounded-pill" style="background-color: #508991;">R$ 0,00</span>
                </li>
              </ul>
              <div class="mt-auto">
                <a href="contas.html" class="btn btn-outline-success w-100">Gerenciar Contas</a>
              </div>
            </div>
          </div>

          <!-- Bloco Cartões -->
          <div class="col-lg-6 d-flex card-align-2">
            <div class="border rounded p-4 d-flex flex-column w-100 bg-white">
              <h4 class="fw-bold mb-3 text-dark">Cartões de Crédito</h4>
              <p><strong>Limite Total:</strong> R$ 0,00</p>
              <p><strong>Gasto Atual:</strong> R$ 0,00</p>
              <ul class="list-group mb-3">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Cartão Nubank
                  <span class="badge text-white rounded-pill" style="background-color: #508991;">R$ 0,00</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Cartão Inter
                  <span class="badge text-white rounded-pill" style="background-color: #508991;">R$ 0,00</span>
                </li>
              </ul>
              <div class="mt-auto">
                <a href="cartoes.html" class="btn btn-outline-success w-100">Gerenciar Cartões</a>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- modal receita -->
    <div class="modal fade" id="modalReceita" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content p-3">
          <h5 class="modal-title mb-3">Adicionar Receita</h5>
          <input id="inputNomeReceita" type="text" class="form-control mb-2" placeholder="Nome">
          <input id="inputValorReceita" type="number" class="form-control mb-2" placeholder="Valor (R$)">
          <button id="btnSalvarReceita" class="btn btn-success w-100">Salvar</button>
        </div>
      </div>
    </div>

    <!-- modal despesa -->
    <div class="modal fade" id="modalDespesa" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content p-3">
          <h5 class="modal-title mb-3">Adicionar Despesa</h5>
          <input id="inputNomeDespesa" type="text" class="form-control mb-2" placeholder="Nome">
          <input id="inputValorDespesa" type="number" class="form-control mb-2" placeholder="Valor (R$)">
          <select id="tagSelect" class="form-select mb-2">
            <option value="">Selecione uma tag</option>
          </select>
          <button id="btnSalvarDespesa" class="btn btn-danger w-100">Salvar</button>
        </div>
      </div>
    </div>

    <!-- modal importar -->
    <div class="modal fade" id="modalImportar" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content p-3">
          <h5 class="modal-title mb-3">Importar Arquivo</h5>
          <input id="inputArquivoCSV" type="file" class="form-control mb-3" accept=".csv">
          <button id="btnImportarCSV" class="btn btn-secondary w-100">Enviar</button>
        </div>
      </div>
    </div>

    <!-- modal lista receita -->
    <div class="modal fade" id="modalListaReceita" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content p-3">
          <h5 class="modal-title mb-3">Lista de Receitas</h5>
          <ul id="listaReceita" class="list-group"></ul>
        </div>
      </div>
    </div>

    <!-- modal lista despesa -->
    <div class="modal fade" id="modalListaDespesa" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content p-3">
          <h5 class="modal-title mb-3">Lista de Despesas</h5>
          <ul id="listaDespesa" class="list-group"></ul>
        </div>
      </div>
    </div>

    <footer>
      <!-- rodapé -->
    </footer>

    <!-- scripts do bootstrap -->
    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>

    <script>
      let receitas = [];
      let despesas = [];
      let tags = ["Alimentação", "Transporte", "Lazer"]; // Tags base
      let goals = [];

      function formatarValor(valor) {
        return `R$ ${valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
      }

      // Função para formatar e exibir a data atual
      function exibirDataAtual() {
        const hoje = new Date();
        const opcoes = { month: 'short', day: '2-digit', year: 'numeric' };
        const dataFormatada = hoje.toLocaleDateString('en-US', opcoes).replace(/(\w{3}) (\d{2}), (\d{4})/, '$1, $2, $3');
        document.getElementById('currentDate').textContent = dataFormatada;
      }

      window.onload = async () => {
        await fetchData();
        await fetchGoals();
        atualizarTotais();
        preencherTags();
        exibirDataAtual();
      };

      async function fetchData() {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            console.error('Token não encontrado no localStorage. Faça login novamente.');
            window.location.href = 'login.html';
            return;
          }

          const revenueResponse = await fetch('http://localhost:8000/finance/revenues/', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          });
          if (!revenueResponse.ok) throw new Error(`Erro na resposta do servidor: ${revenueResponse.status}`);
          receitas = await revenueResponse.json();

          const expenseResponse = await fetch('http://localhost:8000/finance/expenses/', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          });
          if (!expenseResponse.ok) throw new Error(`Erro na resposta do servidor: ${expenseResponse.status}`);
          despesas = await expenseResponse.json();
        } catch (error) {
          console.error('Erro ao buscar dados:', error);
        }
      }

      async function fetchGoals() {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            console.error('Token não encontrado no localStorage. Faça login novamente.');
            window.location.href = 'login.html';
            return;
          }

          const response = await fetch('http://localhost:8000/finance/goals/', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          });
          if (!response.ok) throw new Error(`Erro na resposta do servidor: ${response.status}`);
          goals = await response.json();
          goals.forEach(goal => {
            if (!tags.includes(goal.tag)) tags.push(goal.tag);
          });
        } catch (error) {
          console.error('Erro ao buscar metas:', error);
        }
      }

      function preencherTags() {
        const tagSelect = document.getElementById('tagSelect');
        tagSelect.innerHTML = '<option value="">Selecione uma tag</option>';
        tags.forEach(tag => {
          const option = document.createElement('option');
          option.value = tag;
          option.textContent = tag;
          tagSelect.appendChild(option);
        });
      }

      document.getElementById('btnSalvarReceita').addEventListener('click', async () => {
        const nome = document.getElementById('inputNomeReceita').value;
        const valor = parseFloat(document.getElementById('inputValorReceita').value);
        if (nome && !isNaN(valor)) {
          try {
            const token = localStorage.getItem('token');
            if (!token) {
              console.error('Token não encontrado no localStorage. Faça login novamente.');
              window.location.href = 'login.html';
              return;
            }

            const response = await fetch('http://localhost:8000/finance/revenues/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
              body: JSON.stringify({ name: nome, amount: valor }),
            });
            if (!response.ok) throw new Error(`Erro na resposta do servidor: ${response.status}`);
            const newRevenue = await response.json();
            receitas.push(newRevenue);
            atualizarTotais();
            document.getElementById('inputNomeReceita').value = '';
            document.getElementById('inputValorReceita').value = '';
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalReceita'));
            modal.hide();
          } catch (error) {
            console.error('Erro ao salvar receita:', error);
          }
        }
      });

      document.getElementById('btnSalvarDespesa').addEventListener('click', async () => {
        const nome = document.getElementById('inputNomeDespesa').value;
        const valor = parseFloat(document.getElementById('inputValorDespesa').value);
        const tagSelect = document.getElementById('tagSelect');
        const tag = tagSelect.value || tagSelect.options[tagSelect.selectedIndex].text;
        if (nome && !isNaN(valor)) {
          try {
            const token = localStorage.getItem('token');
            if (!token) {
              console.error('Token não encontrado no localStorage. Faça login novamente.');
              window.location.href = 'login.html';
              return;
            }

            const response = await fetch('http://localhost:8000/finance/expenses/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
              body: JSON.stringify({ name: nome, amount: valor, tag: tag }),
            });
            if (!response.ok) throw new Error(`Erro na resposta do servidor: ${response.status}`);
            const newExpense = await response.json();
            despesas.push(newExpense);
            atualizarTotais();
            document.getElementById('inputNomeDespesa').value = '';
            document.getElementById('inputValorDespesa').value = '';
            tagSelect.value = '';
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDespesa'));
            modal.hide();
          } catch (error) {
            console.error('Erro ao salvar despesa:', error);
          }
        }
      });

      function atualizarTotais() {
        const totalReceita = receitas.reduce((acc, r) => acc + r.amount, 0);
        const totalDespesa = despesas.reduce((acc, d) => acc + d.amount, 0);
        const saldo = totalReceita - totalDespesa;

        document.getElementById('valorTotalReceita').textContent = formatarValor(totalReceita);
        document.getElementById('valorTotalDespesa').textContent = formatarValor(totalDespesa);
        document.getElementById('saldoGeral').textContent = formatarValor(saldo);
      }

      function abrirListaReceita() {
        const lista = document.getElementById('listaReceita');
        lista.innerHTML = '';
        receitas.forEach(r => {
          const item = document.createElement('li');
          item.className = 'list-group-item d-flex justify-content-between align-items-center';
          item.innerHTML = `
            <span>${r.name}</span>
            <span>
              ${formatarValor(r.amount)}
              <button class="btn btn-sm btn-danger ms-2" onclick="deletarReceita(${r.id})">
                <i class="bi bi-trash"></i>
              </button>
            </span>`;
          lista.appendChild(item);
        });
        new bootstrap.Modal(document.getElementById('modalListaReceita')).show();
      }

      async function deletarReceita(id) {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            console.error('Token não encontrado no localStorage. Faça login novamente.');
            window.location.href = 'login.html';
            return;
          }

          const response = await fetch(`http://localhost:8000/finance/revenues/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          });
          if (!response.ok) throw new Error(`Erro na resposta do servidor: ${response.status}`);
          receitas = receitas.filter(r => r.id !== id);
          atualizarTotais();
          abrirListaReceita();
        } catch (error) {
          console.error('Erro ao deletar receita:', error);
        }
      }

      function abrirListaDespesa() {
        const lista = document.getElementById('listaDespesa');
        lista.innerHTML = '';
        despesas.forEach(d => {
          const item = document.createElement('li');
          item.className = 'list-group-item d-flex justify-content-between align-items-center';
          item.innerHTML = `
            <span>${d.name} (Tag: ${d.tag || 'Sem tag'})</span>
            <span>
              ${formatarValor(d.amount)}
              <button class="btn btn-sm btn-danger ms-2" onclick="deletarDespesa(${d.id})">
                <i class="bi bi-trash"></i>
              </button>
            </span>`;
          lista.appendChild(item);
        });
        new bootstrap.Modal(document.getElementById('modalListaDespesa')).show();
      }

      async function deletarDespesa(id) {
        try {
          const token = localStorage.getItem('token');
          if (!token) {
            console.error('Token não encontrado no localStorage. Faça login novamente.');
            window.location.href = 'login.html';
            return;
          }

          const response = await fetch(`http://localhost:8000/finance/expenses/${id}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          });
          if (!response.ok) throw new Error(`Erro na resposta do servidor: ${response.status}`);
          despesas = despesas.filter(d => d.id !== id);
          atualizarTotais();
          abrirListaDespesa();
        } catch (error) {
          console.error('Erro ao deletar despesa:', error);
        }
      }

      document.getElementById("btnImportarCSV").addEventListener("click", async () => {
      const fileInput = document.getElementById("inputArquivoCSV");
      const file = fileInput.files[0];

      if (!file || !file.name.endsWith(".csv")) {
        alert("Selecione um arquivo CSV válido.");
        return;
      }

      const token = localStorage.getItem("token");
      if (!token) {
        alert("Sessão expirada. Faça login novamente.");
        window.location.href = 'login.html';
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch("http://localhost:8000/import/", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
          },
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || "Erro ao importar CSV");
        }

        alert("Importação realizada com sucesso!");
        fileInput.value = ""; // limpa o campo
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalImportar"));
        modal.hide();
        await fetchData(); // atualiza dados na tela
        atualizarTotais();
      } catch (err) {
        console.error(err);
        alert("Erro na importação: " + err.message);
      }
    });

    </script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const token = localStorage.getItem("token");

        if (!token) {
          alert("Usuário não autenticado.");
          return;
        }

        try {
          const response = await fetch("http://localhost:8000/users/me", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Falha ao buscar usuário.");
          }

          const user = await response.json();

          // Exibindo as informações do usuário
          document.getElementById("usernameDisplay").textContent = "Bom dia, " + user.username;

        } catch (error) {
          console.error("Erro ao carregar perfil:", error);
        }
      });
    </script>
  </body>
</html>